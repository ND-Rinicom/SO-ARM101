<!-- 
index.html
Has URL parameters to configure model and positions
- model:              3D model filename (default: so-101.glb)
- xPos, yPos, zPos:   Model position coordinates (default: 0.0,0.0,0.0)
- cameraZPos:         Camera Z position (default: 7.0) 
- wireframe:          Render mode (0 = ghost, 1 = wireframe) (default: 0)
-->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Robot Arm</title>
    <style>
      body { margin: 0; }
      /* background: black; */
    </style>
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@v0.182.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@v0.182.0/examples/jsm/"
        }
    }
    </script>
    <style>
      canvas {
        cursor: grab;
      }

      canvas.rotating {
        cursor: grabbing;
      }

      canvas.panning {
        cursor: all-scroll;
      }

      canvas.zooming {
        cursor: zoom-in;
      }
    </style>
  </head>
  <body>
    <script src="js/mqtt/mqtt.min.js"></script>
	  <script src="js/mqtt/jsonrpcovermqtt.js"></script>
    <script type="module">
    import { loadModel, unloadModel, setJointAngles, setModelPosition, setRenderMode, setModelColor, setModelTransparency } from '/js/3Dmodels.js';
    import { initCameraControls } from '/js/cameraControls.js';

// Extract parameters from URL
const url = new URL(window.location.href);
const urlParams = new URLSearchParams(url.search);

// Model name (base name without extension)
let modelName = 'so-101'; // default
if (urlParams.has('model')) {
  modelName = urlParams.get('model');
  // Strip .glb extension if provided
  if (modelName.endsWith('.glb')) {
    modelName = modelName.slice(0, -4);
  }
}
// Model position (xPos, yPos, zPos)
const xPos = urlParams.has('xPos') ? parseFloat(urlParams.get('xPos')) : 0;
const yPos = urlParams.has('yPos') ? parseFloat(urlParams.get('yPos')) : 0;
const zPos = urlParams.has('zPos') ? parseFloat(urlParams.get('zPos')) : 0;

// Camera Z position
const cameraZPos = urlParams.has('cameraZPos') ? parseFloat(urlParams.get('cameraZPos')) : 1;

// Render mode: wireframe or ghost
const renderModeParam = urlParams.get('wireframe') || 0;

// Apply settings
setModelPosition(xPos, yPos, zPos);
setRenderMode(renderModeParam == 1);

// Load both models
const modelPath = './models/' + modelName;
Promise.all([
  loadModel(modelPath, 'follower'),
  loadModel(modelPath, 'leader')
]).then(([followerLoaded, leaderLoaded]) => {
  if (!followerLoaded && !leaderLoaded) {
    console.warn('Both models failed to load, skipping MQTT initialization');
    return;
  }

  // Set different colors for each model (optional - can be customized via exposed functions)
  if (followerLoaded) {
    setModelColor('follower', 0x88ccff); // Light blue for follower
    setModelTransparency('follower', 0.8); 
  }
  if (leaderLoaded) {
    setModelColor('leader', 0xffffff); // White for leader
  }

  const jsonRpcService = new JsonRpcService('ws://' + url.hostname + ':9000', 'watchman_robotarm/' + modelName +"/#");

  const cameraController = initCameraControls({
    jsonRpcService,
    modelName,
    cameraZPos
  });

  let followerIsRed = false;
  let leaderIsRed = false;
  let lastFollowerTimestamp = null;
  let lastLeaderTimestamp = null;

  // Handle inbound method calls (server -> client)
  jsonRpcService.onMethodCalled = function(topic, message) {
    const method = message.method;
    //console.log('Received method call:', method, 'with Timestamp:', message.timestamp);

    if (method === "finger") {
      jsonRpcService.sendMessage('watchman_robotarm', {
        jsonrpc: "2.0",
        id: message.id,
        result: jsonRpcService.clientId
      });
    } else if (method === "set_follower_joint_angles") {
      const joints = message.params?.joints || {};
      const timestamp = Date.parse(message.timestamp);
      lastLeaderTimestamp = timestamp;
      setJointAngles(joints, 'leader');
      return;
    } else if (method === "set_actual_joint_angles") {
      const joints = message.params?.joints || {};
      const timestamp = message.timestamp;
      lastFollowerTimestamp = timestamp;
      setJointAngles(joints, 'follower');
      return;
    } else if (method === "change-camera") {
      console.log('Received camera update message:', message);
      const params = message.params || {};
      if (params.clientId && params.clientId === jsonRpcService.clientId) {
        console.log('Received camera update from self, ignoring');
        return;
      }
      cameraController.applyRemoteCamera(params);
      return;
    }
  };

  // Expose functions globally for easy access from browser console
  window.robotControl = {
    loadFollower: () => loadModel(modelPath, 'follower'),
    loadLeader: () => loadModel(modelPath, 'leader'),
    unloadFollower: () => unloadModel('follower'),
    unloadLeader: () => unloadModel('leader'),
    setFollowerColor: (color) => setModelColor('follower', color),
    setLeaderColor: (color) => setModelColor('leader', color),
    setFollowerTransparency: (opacity) => setModelTransparency('follower', opacity),
    setLeaderTransparency: (opacity) => setModelTransparency('leader', opacity),
    setFollowerJointAngles: (joints) => setJointAngles(joints, 'follower'),
    setLeaderJointAngles: (joints) => setJointAngles(joints, 'leader')
  };
  console.log('Robot control functions available at window.robotControl');

  // Periodically check if last message is older than 5 seconds and update color
  setInterval(() => {
    const now = Date.now();
    // Follower
    if (lastFollowerTimestamp && (now - lastFollowerTimestamp*1000 > 5000)) {
      if (!followerIsRed) {
        setModelColor('follower', 0xff0000);
        followerIsRed = true;
      }
    } else if (followerIsRed) {
      setModelColor('follower', 0x88ccff);
      followerIsRed = false;
    }
    // Leader
    if (lastLeaderTimestamp && (now - lastLeaderTimestamp > 5000)) {
      if (!leaderIsRed) {
        console.log('Leader data is stale, changing color to red');
        setModelColor('leader', 0xff0000);
        leaderIsRed = true;
      }
    } else if (leaderIsRed) {
      setModelColor('leader', 0xffffff);
      leaderIsRed = false;
    }
  }, 1000);
});
    </script>
  </body>
</html>